<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StP Prompt Studio ‚Äî —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤</title>
  <style>
    :root {
      /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞: –±–æ–ª—å—à–µ —Å–µ—Ä—ã—Ö –ø–æ–¥–ª–æ–∂–µ–∫ –∏ –º—è–≥–∫–∏–µ –∞–∫—Ü–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –Ω–µ —Å–ª–µ–ø–∏–ª–æ */
      --bg: #f3f4f6;
      --panel: #fafafa;         /* –æ—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å–ª–µ–≥–∫–∞ —Å–µ—Ä–∞—è */
      --panel-2: #f3f4f6;       /* –≤–µ—Ä—Ö–Ω–∏–µ –ø–∞–Ω–µ–ª–∏/–ø–æ–¥–ª–æ–∂–∫–∏ */
      --panel-3: #f9fafb;       /* –∫–æ–Ω—Ç—Ä–æ–ª—ã —Ñ–æ—Ä–º */
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --accent: #e31c24;
      --accent-2: #b91c1c;
      --danger: #dc2626;
      --success: #16a34a;
      --warning: #f59e0b;
      --shadow: 0 2px 12px rgba(17,24,39,.06);
      --ring: rgba(227,28,36,.12);
      --hint: #6b7280;
      --chip-bg: #eef2f7;
      --chip-text: #374151;
      --mark-bg: rgba(227,28,36,.12);
      --mark-text: #7f1d1d;
      --app-bg: linear-gradient(180deg, #f6f7f9, #f3f4f6);
      --header-bg: linear-gradient(180deg, rgba(255,255,255,0.9), #ffffff);
    }

    /* ===== –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê ===== */
    [data-theme="dark"] {
      /* –ì–ª–∞–≤–Ω—ã–π —Ü–≤–µ—Ç —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã */
      --bg: #2d2e33;
      --panel: #2d2e33;
      --panel-2: #2a2b2f;
      --panel-3: #26272b;
      --border: #3a3c42;
      --text: #e6e7eb;
      --muted: #a1a1aa;
      --accent: #e31c24;
      --accent-2: #b91c1c;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --shadow: 0 6px 24px rgba(0,0,0,.45);
      --ring: rgba(227,28,36,.25);
      --app-bg: #2d2e33;
      --header-bg: linear-gradient(180deg, rgba(45,46,51,.95), #2d2e33);
      --hint: #a1a1aa;
      --chip-bg: #3a3c42;
      --chip-text: #e6e7eb;
      --mark-bg: rgba(227,28,36,.28);
      --mark-text: #ffffff;
    }
    * { box-sizing: border-box }
    body {
      margin: 0;
      background: var(--app-bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
      min-height: 100dvh;
      display: grid;
      grid-template-rows: 64px 1fr;
    }
    header {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 20px; border-bottom: 1px solid var(--border);
      background: var(--header-bg);
      position: sticky; top: 0; z-index: 10;
    }
    header h1 {
      font-size: 18px; margin: 0; letter-spacing: .3px; font-weight: 700;
      color: var(--text);
    }
    .kbd {
      font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background: var(--panel-3); color: var(--text); border: 1px solid var(--border);
      border-bottom-color: var(--border); padding: 2px 6px; border-radius: 6px;
    }
    .container {
      display: grid; grid-template-columns: 450px 1fr; gap: 12px;
      padding: 12px; height: calc(100dvh - 64px);
    }
    aside {
      border: 1px solid var(--border); border-radius: 12px; background: var(--panel);
      display: grid; grid-template-rows: auto auto 1fr auto; overflow: hidden; box-shadow: var(--shadow);
    }
    main {
      border: 1px solid var(--border); border-radius: 12px; background: var(--panel);
      display: grid; grid-template-rows: auto 1fr auto; overflow: hidden; box-shadow: var(--shadow);
    }
    .toolbar, .toolbar-right {
      display: flex; gap: 8px; padding: 10px; border-bottom: 1px solid var(--border);
      align-items: center; background: var(--panel-2);
    }
    .toolbar-right { justify-content: space-between }
    .search {
      display: flex; gap: 8px; padding: 6px; border-bottom: 1px solid var(--border);
      background: var(--panel-2);
    }
    input[type="text"], textarea, select {
      width: 100%; background: var(--panel-3); color: var(--text);
      border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px;
      outline: none; transition: border .15s ease, box-shadow .15s ease, background .15s ease;
    }
    input[type="text"]:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--ring);
      background: var(--panel);
    }
    input::placeholder, textarea::placeholder { color: var(--muted) }
    textarea {
      min-height: 180px; resize: vertical; font: 14px/1.45 ui-monospace, Menlo, Consolas, monospace;
      white-space: pre-wrap;
    }
    label { font-size: 12px; color: var(--muted); margin-bottom: 6px; display: block }
    .btn {
      background: linear-gradient(180deg, #f8fafc, #f3f4f6);
      border: 1px solid var(--border); color: #1f2937; padding: 8px 12px; border-radius: 8px;
      cursor: pointer; font-weight: 600; font-size: 13px;
    }
    .btn:hover { filter: brightness(0.99) }
    .btn:active { transform: translateY(1px) }
    .btn.primary {
      background: linear-gradient(180deg, #f05252, #e31c24);
      border-color: #e31c24; color: #ffffff;
    }
    .btn.danger { border-color: #dc2626; background: linear-gradient(180deg, #ef4444, #dc2626); color: #fff }
    .btn.ghost { background: transparent; border-color: var(--border) }
    /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫: —á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–æ–¥–ª–æ–∂–∫–∏ */
    [data-theme="dark"] .btn {
      background: linear-gradient(180deg, #3a3c42, #2f3035);
      border-color: #4a4c54;
      color: var(--text);
    }
    [data-theme="dark"] .btn.ghost { background: transparent; border-color: #4a4c54; color: var(--text) }
    [data-theme="dark"] .btn.primary { background: linear-gradient(180deg, #e64949, #c81e1e); border-color: #c81e1e; color: #ffffff }
    .list {
      overflow: auto; padding: 8px;
    }
    .item {
      border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-bottom: 8px;
      background: var(--panel-3);
      cursor: pointer;
    }
    .item:hover { background: var(--panel); border-color: #d1d5db }
    .item.active { background: var(--panel); border-color: var(--accent); box-shadow: 0 0 0 3px var(--ring) }
    .item h4 { margin: 0 0 6px; font-size: 14px }
    .tags { display: flex; gap: 6px; flex-wrap: wrap }
    .tag {
      font-size: 11px; color: var(--chip-text); border: 1px solid var(--border);
      padding: 2px 8px; border-radius: 999px; background: var(--chip-bg);
    }
    .editor { padding: 12px; overflow: auto; display: grid; gap: 12px }
    .row { display: grid; gap: 6px }
    .row.cols { grid-template-columns: 1fr 1fr; gap: 12px }
    .preview {
      border-top: 1px solid var(--border); background: var(--panel-2);
      padding: 12px; display: grid; gap: 8px;
    }
    .preview-box {
      border: 1px solid var(--border); border-radius: 8px; background: var(--panel);
      padding: 12px; font: 14px/1.5 ui-monospace, Menlo, Consolas, monospace; white-space: pre-wrap;
      /* –î–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ mark */
      word-break: break-word;
    }
    .preview-box mark {
      background: var(--mark-bg);
      color: var(--mark-text);
      padding: 0 4px;
      border-radius: 4px;
    }
    .vars { display: grid; gap: 8px; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) }
    .muted { color: var(--muted); font-size: 12px }
    .footer {
      border-top: 1px solid var(--border); padding: 8px 10px; display: flex; gap: 8px; justify-content: space-between;
      background: var(--panel-2);
    }
    .spacer { flex: 1 }
    .hint { color: var(--hint); font-size: 12px }
    .inline { display: inline-flex; gap: 6px; align-items: center }
    .divider { height: 1px; background: var(--border); margin: 4px 0 8px }
    .danger-zone { display: flex; gap: 8px; flex-wrap: wrap }
    @media (max-width: 980px) {
      .container { grid-template-columns: 1fr; height: auto }
      aside { min-height: 40dvh }
      main { min-height: 60dvh }
    }

    /* –†–∞–∑–¥–µ–ª—ã (–±–æ–ª—å—à–∏–µ –≤–∫–ª–∞–¥–∫–∏) */
    .sections-bar {
      display: flex; gap: 8px; padding: 10px; border-bottom: 1px solid var(--border);
      background: var(--panel-2); align-items: center; flex-wrap: wrap;
    }
    .tabs { display: flex; gap: 8px; flex-wrap: wrap; }
    .tab {
      padding: 10px 14px; border: 1px solid var(--border); border-radius: 999px; cursor: pointer;
      background: var(--panel-3); color: var(--text); font-weight: 600; letter-spacing: .2px;
    }
    .tab:hover { border-color: var(--accent) }
    .tab.active { background: var(--panel); border-color: var(--accent); color: var(--text); box-shadow: 0 0 0 3px var(--ring) }
    .sections-actions { margin-left: auto; display: flex; gap: 8px }
  </style>
</head>
<body>
  <header>
    <h1>StP Prompt Studio</h1>
    <span class="muted">–®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π</span>
    <span class="spacer"></span>
    <div class="inline">
      <button id="themeBtn" class="btn ghost">–¢–µ–º–∞: –°–≤–µ—Ç–ª–∞—è</button>
    </div>
    <span class="hint inline">–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:
      <span class="kbd">Ctrl</span>+<span class="kbd">S</span> —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
      <span class="kbd">Ctrl</span>+<span class="kbd">N</span> –Ω–æ–≤—ã–π
      <span class="kbd">Ctrl</span>+<span class="kbd">B</span> –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
      <span class="kbd">Ctrl</span>+<span class="kbd">E</span> —ç–∫—Å–ø–æ—Ä—Ç
    </span>
  </header>

  <div class="container">
    <aside>
      <div class="toolbar">
        <button id="newBtn" class="btn primary">–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω</button>
        <button id="dupBtn" class="btn">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="moveBtn" class="btn">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
        <button id="delBtn" class="btn danger">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
      <div class="sections-bar">
        <div class="tabs" id="sectionsBar"></div>
        <div class="sections-actions">
          <button id="manageSectionsBtn" class="btn">–†–∞–∑–¥–µ–ª—ã</button>
        </div>
      </div>
      <div class="search">
        <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–æ–ø–∏—Å–∞–Ω–∏—é/—Ç–µ–≥–∞–º‚Ä¶" />
        <button id="clearSearchBtn" class="btn ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
      <div id="list" class="list"></div>
      <div class="footer">
        <div class="inline">
          <input id="importFile" type="file" accept="application/json" style="display:none" />
          <button id="importBtn" class="btn">–ò–º–ø–æ—Ä—Ç</button>
          <button id="exportBtn" class="btn">–≠–∫—Å–ø–æ—Ä—Ç</button>
        </div>
        <span class="muted" id="countInfo"></span>
      </div>
    </aside>

    <main>
      <div class="toolbar-right">
        <div class="inline">
          <button id="saveBtn" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="copyBtn" class="btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏—Ç–æ–≥</button>
        </div>
        <div class="inline">
          <span class="muted">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:</span>
          <span id="savedAt" class="hint">‚Äî</span>
        </div>
        <div class="inline">
          <button id="cloudPullBtn" class="btn ghost">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
          <button id="cloudPushBtn" class="btn ghost">–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
          <button id="settingsBtn" class="btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
      </div>

      <div class="editor">
        <div class="row cols">
          <div class="row">
            <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input id="title" type="text" placeholder="–ù–∞–ø—Ä.: –õ–∞–∫–æ–Ω–∏—á–Ω–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è" />
          </div>
          <div class="row">
            <label for="tags">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
            <input id="tags" type="text" placeholder="summarize, ru, short" />
          </div>
        </div>

        <div class="row">
          <label for="sectionSelect">–†–∞–∑–¥–µ–ª</label>
          <select id="sectionSelect"></select>
        </div>

        <div class="row cols">
          <div class="row">
            <label for="desc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <input id="desc" type="text" placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞" />
          </div>
          <div class="row">
            <label for="author">–ê–≤—Ç–æ—Ä</label>
            <input id="author" type="text" placeholder="–ò–º—è –∏–ª–∏ –Ω–∏–∫ –∞–≤—Ç–æ—Ä–∞" />
          </div>
        </div>

        <div class="row">
          <label for="content">
            –¢–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –≤–∏–¥–∞ {{variable}}). 
            <span class="inline">
              <button id="wrapSelectionBtn" class="btn ghost">–í—ã–¥–µ–ª–µ–Ω–Ω–æ–µ ‚Üí {{var}}</button>
            </span>
          </label>
          <textarea id="content" placeholder="–ü—Ä–∏–º–µ—Ä:
–í—ã—Å—Ç—É–ø–∞–π –∫–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–µ–º–µ.
–°—É–º–º–∏—Ä—É–π —Ç–µ–∫—Å—Ç —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ {{audience}}.
–¢—Ä–µ–±—É–µ–º—ã–π —Å—Ç–∏–ª—å: {{tone}}.
–¢–µ–∫—Å—Ç:
{{input}}"></textarea>
        </div>

        <div>
          <div class="inline">
            <strong>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ</strong>
            <span class="muted">–æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤ —Ç–µ–∫—Å—Ç–µ —à–∞–±–ª–æ–Ω–∞</span>
          </div>
          <div class="vars" id="vars"></div>
        </div>
        <div class="divider"></div>
        <div class="danger-zone">
          <button id="resetVarsBtn" class="btn ghost">–°–±—Ä–æ—Å–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö</button>
          <button id="clearTemplateBtn" class="btn ghost">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
        </div>
      </div>

      <div class="preview">
        <div class="inline">
          <strong>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏—Ç–æ–≥–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞</strong>
          <span class="muted">–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–¥—Å–≤–µ—á–µ–Ω—ã</span>
        </div>
        <div class="preview-box" id="preview"></div>
      </div>
    </main>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–±–ª–∞–∫–∞ -->
  <div id="settingsModal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 100; align-items: center; justify-content: center;">
    <div style="background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 12px; width: min(640px, 96vw); box-shadow: var(--shadow);">
      <div style="display:flex; align-items:center; justify-content: space-between; padding:12px 14px; border-bottom:1px solid var(--border); background: var(--panel-2);">
        <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–ª–∞–∫–∞ (Supabase)</strong>
        <button id="settingsClose" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div style="padding: 12px; display: grid; gap: 10px;">
        <div class="row">
          <label for="supabaseUrl">URL –ø—Ä–æ–µ–∫—Ç–∞ (https://...supabase.co)</label>
          <input id="supabaseUrl" type="text" placeholder="https://xxxx.supabase.co" />
        </div>
        <div class="row">
          <label for="supabaseKey">Anon Public Key</label>
          <input id="supabaseKey" type="text" placeholder="ey..." />
        </div>
        <div class="row cols">
          <div class="row">
            <label for="supabaseTable">–¢–∞–±–ª–∏—Ü–∞</label>
            <input id="supabaseTable" type="text" placeholder="templates" value="templates" />
          </div>
          <div class="row">
            <label for="cloudScope">–û–±–ª–∞–∫–æ: —á—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</label>
            <select id="cloudScope">
              <option value="templates">–¢–æ–ª—å–∫–æ —à–∞–±–ª–æ–Ω—ã</option>
              <option value="all">–®–∞–±–ª–æ–Ω—ã + —Ä–∞–∑–¥–µ–ª—ã + –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ</option>
            </select>
          </div>
        </div>
        <div class="inline" style="justify-content: flex-end; gap:8px;">
          <button id="settingsSave" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="muted">–°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: id (text, PK), title (text), description (text), tags (jsonb), content (text), sectionId (text), updatedAt (timestamptz), author (text).</div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞–º–∏ -->
  <div id="sectionsModal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 100; align-items: center; justify-content: center;">
    <div style="background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 12px; width: min(720px, 96vw); box-shadow: var(--shadow);">
      <div style="display:flex; align-items:center; justify-content: space-between; padding:12px 14px; border-bottom:1px solid var(--border); background: var(--panel-2);">
        <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞–º–∏</strong>
        <button id="sectionsClose" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div style="display:grid; grid-template-columns: 1fr 280px; gap: 12px; padding: 12px;">
        <div id="sectionsTree" style="max-height: 60dvh; overflow:auto; border: 1px solid var(--border); border-radius: 8px; padding: 8px; background: var(--panel-3);"></div>
        <div style="display:grid; gap:8px; align-content:start">
          <button id="addRootSectionBtn" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª</button>
          <button id="addChildSectionBtn" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª</button>
          <button id="renameSectionBtn" class="btn">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
          <button id="deleteSectionBtn" class="btn danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          <div class="muted">–ü–æ–¥—Ä–∞–∑–¥–µ–ª—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å–≤—è–∑—å parentId.</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== –£—Ç–∏–ª–∏—Ç—ã =====
    const byId = (id) => document.getElementById(id);
    const uuid = () => (crypto?.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2));
    const nowIso = () => new Date().toISOString();
    const formatDate = (iso) => iso ? new Date(iso).toLocaleString() : '‚Äî';

    const STORAGE_KEY = 'prompt_studio.templates.v1';
    const VARS_KEY = 'prompt_studio.variables.v1';
    const SECTIONS_KEY = 'prompt_studio.sections.v1';
    const THEME_KEY = 'prompt_studio.theme.v1';
    const PLACEHOLDER_RE = /\{\{\s*([a-zA-Z0-9_]+)\s*\}\}/g;

    function dedupe(arr, key) {
      const seen = new Set();
      const res = [];
      for (const it of arr) {
        if (seen.has(it[key])) continue;
        seen.add(it[key]); res.push(it);
      }
      return res;
    }

    function extractVars(text) {
      if (!text) return [];
      const set = new Set();
      let m;
      while ((m = PLACEHOLDER_RE.exec(text)) !== null) set.add(m[1]);
      return Array.from(set);
    }

    function compile(text, varsMap) {
      if (!text) return '';
      return text.replace(PLACEHOLDER_RE, (_, name) => {
        const v = (varsMap?.[name] ?? '');
        return v === '' ? `¬´${name}?¬ª` : v;
      });
    }

    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–æ–∫
    function highlightCompiled(text, varsMap) {
      // –°–Ω–∞—á–∞–ª–∞ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å XSS –∏ –ø–æ—Ç–µ—Ä–∏ —Ä–∞–∑–º–µ—Ç–∫–∏
      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      // –ó–∞—Ç–µ–º –∑–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –Ω–∞ mark
      html = html.replace(PLACEHOLDER_RE, (_, name) => {
        const v = (varsMap?.[name] ?? '');
        const shown = v === '' ? `¬´${name}?¬ª` : v
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;');
        return `<mark>${shown}</mark>`;
      });
      return html;
    }

    // ===== –•—Ä–∞–Ω–∏–ª–∏—â–µ =====
    function loadSections() {
      try {
        const raw = localStorage.getItem(SECTIONS_KEY);
        if (!raw) return seedSections();
        const arr = JSON.parse(raw);
        return Array.isArray(arr) && arr.length ? arr : seedSections();
      } catch { return seedSections(); }
    }

    function saveSections(list) {
      localStorage.setItem(SECTIONS_KEY, JSON.stringify(list));
    }

    function seedSections() {
      const base = [
        { id: uuid(), name: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥', parentId: null },
        { id: uuid(), name: '–ö—Ä–µ–∞—Ç–∏–≤', parentId: null },
        { id: uuid(), name: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞', parentId: null },
        { id: uuid(), name: '–î–∏–∑–∞–π–Ω', parentId: null }
      ];
      saveSections(base);
      return base;
    }

    function loadTemplates() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return seedTemplates();
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : seedTemplates();
      } catch { return seedTemplates(); }
    }

    function saveTemplates(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function loadVars() {
      try {
        const raw = localStorage.getItem(VARS_KEY);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }

    function saveVars(allVars) {
      localStorage.setItem(VARS_KEY, JSON.stringify(allVars));
    }

    function seedTemplates() {
      const demo = [
        {
          id: uuid(),
          title: '–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞',
          description: '–ö—Ä–∞—Ç–∫–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ, –±–µ–∑ –≤–æ–¥—ã',
          author: '',
          tags: ['ru','summary','concise'],
          sectionId: null,
          content:
`–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–∂–∞—Ç–∏—é —Ç–µ–∫—Å—Ç–∞.
–¶–µ–ª—å: –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫—Ä–∞—Ç–∫—É—é –≤—ã–∂–∏–º–∫—É –¥–ª—è {{audience}}.
–°—Ç–∏–ª—å: {{tone}}. –§–æ—Ä–º–∞—Ç: –ø—É–Ω–∫—Ç—ã —Å–ø–∏—Å–∫–∞ (–¥–æ 7).
–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞: –∫–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏, –º–µ—Ç—Ä–∏–∫–∏, –≤—ã–≤–æ–¥—ã.
–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:
{{input}}`,
          updatedAt: nowIso()
        },
        {
          id: uuid(),
          title: '–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ —Å —É—Ç–æ—á–Ω–µ–Ω–∏–µ–º',
          description: '–£–ª—É—á—à–∏—Ç—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–º—ã—Å–ª',
          author: '',
          tags: ['ru','rewrite','clarify'],
          sectionId: null,
          content:
`–ü–µ—Ä–µ–ø–∏—à–∏ —Ç–µ–∫—Å—Ç —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª —è—Å–Ω–µ–µ –¥–ª—è {{audience}}.
–°–æ—Ö—Ä–∞–Ω–∏ —Å–º—ã—Å–ª, —É–±–µ—Ä–∏ –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–µ–¥–ª–æ–∂–∏ –ª—É—á—à–∏–µ —Ç–µ—Ä–º–∏–Ω—ã.
–¢–æ–Ω: {{tone}}. –í–µ—Ä–Ω–∏ 1‚Äì2 –≤–∞—Ä–∏–∞–Ω—Ç–∞.
–¢–µ–∫—Å—Ç:
{{input}}`,
          updatedAt: nowIso()
        },
        {
          id: uuid(),
          title: '–ü–ª–∞–Ω —Å—Ç–∞—Ç—å–∏',
          description: '–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Å—Ç–∞—Ç—å–∏ –ø–æ–¥ SEO',
          author: '',
          tags: ['ru','seo','content'],
          sectionId: null,
          content:
`–°–æ—Å—Ç–∞–≤—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ "{{keyword}}".
–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: {{audience}}. –¢–æ–Ω: {{tone}}.
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ó–∞–≥–æ–ª–æ–≤–∫–∏ H2/H3
- –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- –ë–ª–æ–∫ FAQ
- –ü—Ä–∏–º–µ—Ä–Ω—ã–µ —Ç–µ–∑–∏—Å—ã –∫ –∫–∞–∂–¥–æ–º—É —Ä–∞–∑–¥–µ–ª—É`,
          updatedAt: nowIso()
        }
      ];
      saveTemplates(demo);
      return demo;
    }

    // ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ =====
    let sections = loadSections();
    let templates = loadTemplates();
    let allVars = loadVars(); // { [templateId]: { varName: value } }
    let currentId = templates[0]?.id ?? null;
    let currentSectionId = sections[0]?.id ?? null; // –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    let searchQuery = '';

    // ===== –≠–ª–µ–º–µ–Ω—Ç—ã =====
    const listEl = byId('list');
    const sectionsBarEl = byId('sectionsBar');
    const searchInput = byId('searchInput');
    const clearSearchBtn = byId('clearSearchBtn');
    const countInfo = byId('countInfo');

    const titleEl = byId('title');
    const tagsEl = byId('tags');
    const descEl = byId('desc');
    const authorEl = byId('author');
    const contentEl = byId('content');
    const varsEl = byId('vars');
    const previewEl = byId('preview');
    const savedAtEl = byId('savedAt');
    const sectionSelectEl = byId('sectionSelect');

    const newBtn = byId('newBtn');
    const dupBtn = byId('dupBtn');
    const moveBtn = byId('moveBtn');
    const delBtn = byId('delBtn');
    const saveBtn = byId('saveBtn');
    const copyBtn = byId('copyBtn');
    const resetVarsBtn = byId('resetVarsBtn');
    const clearTemplateBtn = byId('clearTemplateBtn');
    const wrapSelectionBtn = byId('wrapSelectionBtn');
    const manageSectionsBtn = byId('manageSectionsBtn');
    const themeBtn = byId('themeBtn');
    const settingsBtn = byId('settingsBtn');
    const cloudPullBtn = byId('cloudPullBtn');
    const cloudPushBtn = byId('cloudPushBtn');

    const importBtn = byId('importBtn');
    const exportBtn = byId('exportBtn');
    const importFile = byId('importFile');
    const settingsModal = byId('settingsModal');
    const settingsClose = byId('settingsClose');
    const settingsSave = byId('settingsSave');
    const supabaseUrlEl = byId('supabaseUrl');
    const supabaseKeyEl = byId('supabaseKey');
    const supabaseTableEl = byId('supabaseTable');
    const cloudScopeEl = byId('cloudScope');

    // ===== –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ =====
    function matchesQuery(t, q) {
      if (!q) return true;
      const s = q.toLowerCase();
      return (
        t.title.toLowerCase().includes(s) ||
        (t.description || '').toLowerCase().includes(s) ||
        (t.tags || []).join(' ').toLowerCase().includes(s)
      );
    }

    function renderList() {
      const filtered = templates.filter(t => {
        const bySection = currentSectionId ? (t.sectionId === currentSectionId) : true;
        const match = bySection && matchesQuery(t, searchQuery);
        if (!match && searchQuery) {
          const s = searchQuery.toLowerCase();
          return (t.author || '').toLowerCase().includes(s);
        }
        return match;
      });
      listEl.innerHTML = '';
      for (const t of filtered) {
        const div = document.createElement('div');
        div.className = 'item' + (t.id === currentId ? ' active' : '');
        div.innerHTML = `
          <h4>${escapeHtml(t.title)}</h4>
          <div class="muted" style="margin-bottom:6px">${escapeHtml(t.description || '')}</div>
          ${t.author ? `<div class=\"muted\" style=\"margin-bottom:6px\">–ê–≤—Ç–æ—Ä: ${escapeHtml(t.author)}</div>` : ''}
          <div class="tags">${(t.tags || []).map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join(' ')}</div>
        `;
        div.addEventListener('click', () => { currentId = t.id; renderAll(); });
        listEl.appendChild(div);
      }
      const sectionName = sections.find(s => s.id === currentSectionId)?.name || '‚Äî';
      countInfo.textContent = `–†–∞–∑–¥–µ–ª: ${sectionName} ‚Ä¢ –ü–æ–∫–∞–∑–∞–Ω–æ: ${filtered.length} ‚Ä¢ –í—Å–µ–≥–æ: ${templates.length}`;
    }

    function escapeHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;');
    }

    // ===== –†–µ–¥–∞–∫—Ç–æ—Ä/–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä =====
    function getCurrent() {
      return templates.find(t => t.id === currentId) || null;
    }

    function loadEditor(t) {
      if (!t) {
        titleEl.value = '';
        tagsEl.value = '';
        descEl.value = '';
        authorEl.value = '';
        contentEl.value = '';
        savedAtEl.textContent = '‚Äî';
        varsEl.innerHTML = '';
        previewEl.textContent = '';
        return;
      }
      titleEl.value = t.title || '';
      tagsEl.value = (t.tags || []).join(', ');
      descEl.value = t.description || '';
      authorEl.value = t.author || '';
      contentEl.value = t.content || '';
      savedAtEl.textContent = formatDate(t.updatedAt);
      renderSectionSelect();
      renderVarsAndPreview();
    }

    function collectEditor() {
      const t = getCurrent();
      const base = {
        id: t?.id ?? uuid(),
        title: titleEl.value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
        description: descEl.value.trim(),
        author: authorEl.value.trim(),
        tags: tagsEl.value.split(',').map(s => s.trim()).filter(Boolean),
        content: contentEl.value,
        sectionId: sectionSelectEl.value || currentSectionId,
        updatedAt: nowIso()
      };
      return base;
    }

    function renderVarsAndPreview() {
      const t = getCurrent();
      const content = contentEl.value;
      const names = extractVars(content);
      const currentVars = allVars[t?.id || 'tmp'] || {};
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: —É–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      for (const k of Object.keys(currentVars)) {
        if (!names.includes(k)) delete currentVars[k];
      }
      varsEl.innerHTML = '';
      if (names.length === 0) {
        varsEl.innerHTML = '<span class="muted">–ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {{variable}}.</span>';
      } else {
        for (const name of names) {
          const wrap = document.createElement('div');
          wrap.className = 'row';
          const id = 'var_' + name;
          wrap.innerHTML = `
            <label for="${id}">${name}</label>
            <input type="text" id="${id}" placeholder="${name}" value="${(currentVars[name] ?? '').replace(/"/g,'&quot;')}" />
          `;
          const input = wrap.querySelector('input');
          input.addEventListener('input', () => {
            const key = t?.id || 'tmp';
            allVars[key] = allVars[key] || {};
            allVars[key][name] = input.value;
            saveVars(allVars);
            updatePreview();
          });
          varsEl.appendChild(wrap);
        }
      }
      updatePreview();
    }

    function updatePreview() {
      const t = getCurrent();
      const key = t?.id || 'tmp';
      const compiled = compile(contentEl.value, allVars[key] || {});
      previewEl.innerHTML = highlightCompiled(contentEl.value, allVars[key] || {})
        .replace(/\n/g, '<br/>');
    }

    // ===== –†–∞–∑–¥–µ–ª—ã =====
    function ensureTemplateSections() {
      // –î–ª—è —à–∞–±–ª–æ–Ω–æ–≤ –±–µ–∑ —Ä–∞–∑–¥–µ–ª–∞ ‚Äî –Ω–∞–∑–Ω–∞—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∏–ª–∏ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
      const fallback = sections[0]?.id || null;
      let changed = false;
      for (const t of templates) {
        if (!t.sectionId) { t.sectionId = fallback; changed = true; }
      }
      if (changed) saveTemplates(templates);
    }

    function buildSectionTree(list) {
      const byParent = new Map();
      for (const s of list) {
        const p = s.parentId || null;
        if (!byParent.has(p)) byParent.set(p, []);
        byParent.get(p).push(s);
      }
      for (const [, arr] of byParent) arr.sort((a,b)=>a.name.localeCompare(b.name,'ru'));
      function renderNodes(parentId, level=0) {
        const arr = byParent.get(parentId || null) || [];
        const out = [];
        for (const s of arr) {
          out.push({ ...s, level });
          out.push(...renderNodes(s.id, level+1));
        }
        return out;
      }
      return renderNodes(null, 0);
    }

    function renderSectionsBar() {
      sectionsBarEl.innerHTML = '';
      const flat = buildSectionTree(sections);
      for (const s of flat) {
        const b = document.createElement('button');
        b.className = 'tab' + (s.id === currentSectionId ? ' active' : '');
        b.textContent = (s.level ? '‚ñ∏ '.repeat(s.level) : '') + s.name;
        b.addEventListener('click', () => {
          currentSectionId = s.id;
          renderAll();
        });
        sectionsBarEl.appendChild(b);
      }
    }

    function renderSectionSelect() {
      const flat = buildSectionTree(sections);
      sectionSelectEl.innerHTML = flat.map(s => `<option value="${s.id}">${(s.level? '‚ñ∏ '.repeat(s.level):'') + s.name}</option>`).join('');
      const t = getCurrent();
      const value = t?.sectionId || currentSectionId || sections[0]?.id || '';
      sectionSelectEl.value = value;
    }

    // ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞–º–∏ (–º–æ–¥–∞–ª) =====
    const sectionsModal = byId('sectionsModal');
    const sectionsClose = byId('sectionsClose');
    const sectionsTreeEl = byId('sectionsTree');
    const addRootSectionBtn = byId('addRootSectionBtn');
    const addChildSectionBtn = byId('addChildSectionBtn');
    const renameSectionBtn = byId('renameSectionBtn');
    const deleteSectionBtn = byId('deleteSectionBtn');
    let selectedSectionId = null;

    function openSectionsModal() {
      selectedSectionId = currentSectionId;
      renderSectionsTree();
      sectionsModal.style.display = 'flex';
    }
    function closeSectionsModal() { sectionsModal.style.display = 'none'; }

    function renderSectionsTree() {
      const flat = buildSectionTree(sections);
      sectionsTreeEl.innerHTML = '';
      for (const s of flat) {
        const row = document.createElement('div');
        row.style.padding = '6px 8px';
        row.style.cursor = 'pointer';
        row.style.borderRadius = '8px';
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.innerHTML = `<span style="opacity:.7;margin-right:6px">${'‚Äî '.repeat(s.level)}</span><span>${escapeHtml(s.name)}</span>`;
        if (s.id === selectedSectionId) { row.style.background = 'var(--panel)'; row.style.boxShadow = '0 0 0 3px var(--ring)'; }
        row.addEventListener('click', () => { selectedSectionId = s.id; renderSectionsTree(); });
        sectionsTreeEl.appendChild(row);
      }
    }

    function addSectionRoot() {
      const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞:', '–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª');
      if (!name) return;
      const s = { id: uuid(), name: name.trim(), parentId: null };
      sections.push(s); saveSections(sections);
      currentSectionId = s.id; renderSectionsBar(); renderList(); renderSectionSelect(); renderSectionsTree();
    }
    function addSectionChild() {
      if (!selectedSectionId) { toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª'); return; }
      const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞:', '–ù–æ–≤—ã–π –ø–æ–¥—Ä–∞–∑–¥–µ–ª');
      if (!name) return;
      const s = { id: uuid(), name: name.trim(), parentId: selectedSectionId };
      sections.push(s); saveSections(sections);
      currentSectionId = s.id; renderSectionsBar(); renderList(); renderSectionSelect(); renderSectionsTree();
    }
    function renameSection() {
      if (!selectedSectionId) { toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª'); return; }
      const s = sections.find(x => x.id === selectedSectionId);
      if (!s) return; 
      const name = prompt('–ù–æ–≤–æ–µ –∏–º—è —Ä–∞–∑–¥–µ–ª–∞:', s.name);
      if (!name) return; s.name = name.trim(); saveSections(sections);
      renderSectionsBar(); renderList(); renderSectionSelect(); renderSectionsTree();
    }
    function deleteSection() {
      if (!selectedSectionId) { toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª'); return; }
      const subtreeIds = (function collect(id){
        const children = sections.filter(x => x.parentId === id).map(x=>x.id);
        return [id, ...children.flatMap(collect)];
      })(selectedSectionId);
      const affected = templates.filter(t => subtreeIds.includes(t.sectionId)).length;
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª –∏ –µ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã? –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤: ${affected}. –û–Ω–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∫–æ—Ä–µ–Ω—å.`)) return;
      // –£–¥–∞–ª—è–µ–º —Ä–∞–∑–¥–µ–ª—ã
      sections = sections.filter(s => !subtreeIds.includes(s.id));
      saveSections(sections);
      // –ü–µ—Ä–µ–Ω–æ—Å–∏–º —à–∞–±–ª–æ–Ω—ã –≤ –±–ª–∏–∂–∞–π—à–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫–æ—Ä–µ–Ω—å (null -> –ø–µ—Ä–≤—ã–π –∫–æ—Ä–Ω–µ–≤–æ–π)
      const firstRoot = (sections.find(s => !s.parentId)?.id) || null;
      for (const t of templates) {
        if (subtreeIds.includes(t.sectionId)) t.sectionId = firstRoot;
      }
      saveTemplates(templates);
      currentSectionId = firstRoot;
      renderSectionsBar(); renderList(); renderSectionSelect(); renderSectionsTree();
    }

    // ===== –î–µ–π—Å—Ç–≤–∏—è =====
    function createNewTemplate() {
      const t = {
        id: uuid(),
        title: '–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω',
        description: '',
        tags: [],
        content: '',
        sectionId: currentSectionId,
        updatedAt: nowIso()
      };
      templates.unshift(t);
      saveTemplates(templates);
      currentId = t.id;
      renderAll();
      titleEl.focus();
    }

    function duplicateTemplate() {
      const t = getCurrent();
      if (!t) return;
      const copy = { ...t, id: uuid(), title: t.title + ' (–∫–æ–ø–∏—è)', updatedAt: nowIso() };
      templates.unshift(copy);
      // –ö–æ–ø–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      if (allVars[t.id]) {
        allVars[copy.id] = { ...allVars[t.id] };
        saveVars(allVars);
      }
      saveTemplates(templates);
      currentId = copy.id;
      renderAll();
    }

    function moveTemplateToSection() {
      const t = getCurrent();
      if (!t) return;
      const options = sections.map((s, i) => `${i + 1}. ${s.name}`).join('\n');
      const input = prompt(`–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å ¬´${t.title}¬ª –≤ —Ä–∞–∑–¥–µ–ª:\n${options}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ä–∞–∑–¥–µ–ª–∞:`, '1');
      const idx = Number(input) - 1;
      if (Number.isNaN(idx) || idx < 0 || idx >= sections.length) return;
      const target = sections[idx];
      t.sectionId = target.id;
      t.updatedAt = nowIso();
      saveTemplates(templates);
      renderAll();
      toast(`–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ ¬´${target.name}¬ª`);
    }

    function deleteTemplate() {
      const t = getCurrent();
      if (!t) return;
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω ¬´${t.title}¬ª?`)) return;
      templates = templates.filter(x => x.id !== t.id);
      delete allVars[t.id];
      saveVars(allVars);
      saveTemplates(templates);
      currentId = templates[0]?.id || null;
      renderAll();
    }

    function saveTemplate() {
      const updated = collectEditor();
      const idx = templates.findIndex(t => t.id === updated.id);
      if (idx === -1) templates.unshift(updated);
      else templates[idx] = updated;
      saveTemplates(templates);
      savedAtEl.textContent = formatDate(updated.updatedAt);
      renderList();
      // –ø–µ—Ä–µ–Ω–æ—Å –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π id
      if (allVars['tmp'] && !allVars[updated.id]) {
        allVars[updated.id] = { ...allVars['tmp'] }; delete allVars['tmp']; saveVars(allVars);
      }
      toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    }

    function clearTemplateForm() {
      titleEl.value = '';
      tagsEl.value = '';
      descEl.value = '';
      contentEl.value = '';
      renderVarsAndPreview();
    }

    function resetVariablesValues() {
      const t = getCurrent();
      if (!t) return;
      allVars[t.id] = {};
      saveVars(allVars);
      renderVarsAndPreview();
      toast('–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã');
    }

    function copyCompiled() {
      const t = getCurrent();
      const key = t?.id || 'tmp';
      const compiled = compile(contentEl.value, allVars[key] || {});
      navigator.clipboard.writeText(compiled).then(() => toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'));
    }

    function wrapSelectionWithVar() {
      const selStart = contentEl.selectionStart;
      const selEnd = contentEl.selectionEnd;
      const hasSelection = selEnd > selStart;
      const raw = contentEl.value;
      if (!hasSelection) {
        const v = prompt('–ò–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (a‚Äìz, 0‚Äì9, _):', 'variable');
        if (!v) return;
        const insert = `{{${v}}}`;
        const pos = contentEl.selectionStart;
        contentEl.value = raw.slice(0, pos) + insert + raw.slice(pos);
        contentEl.focus();
        contentEl.selectionStart = contentEl.selectionEnd = pos + insert.length;
      } else {
        const v = prompt('–ò–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:', 'variable');
        if (!v) return;
        const replaced = raw.slice(0, selStart) + `{{${v}}}` + raw.slice(selEnd);
        contentEl.value = replaced;
      }
      renderVarsAndPreview();
    }

    // ===== –ò–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç =====
    function exportData() {
      const data = { templates, variables: allVars, sections, exportedAt: nowIso(), app: 'prompt-studio' };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `prompt-templates-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importData(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(String(reader.result || '{}'));
          const incoming = Array.isArray(parsed) ? parsed : (Array.isArray(parsed.templates) ? parsed.templates : []);
          if (incoming.length === 0) { alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª –∏–º–ø–æ—Ä—Ç–∞'); return; }
          // merge
          const map = new Map(templates.map(t => [t.id, t]));
          for (const it of incoming) {
            if (!it.id) it.id = uuid();
            map.set(it.id, { ...it, updatedAt: it.updatedAt || nowIso() });
          }
          templates = Array.from(map.values()).sort((a,b) => (b.updatedAt || '').localeCompare(a.updatedAt || ''));
          // variables
          if (parsed.variables && typeof parsed.variables === 'object') {
            allVars = { ...allVars, ...parsed.variables };
            saveVars(allVars);
          }
          // sections (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π parentId)
          if (parsed.sections && Array.isArray(parsed.sections) && parsed.sections.length) {
            const byId = new Map(sections.map(s => [s.id, s]));
            for (const s of parsed.sections) {
              const id = s.id || uuid();
              byId.set(id, { id, name: s.name, parentId: s.parentId || null });
            }
            sections = Array.from(byId.values());
            saveSections(sections);
          }
          saveTemplates(templates);
          renderAll();
          toast(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${incoming.length}`);
        } catch (e) {
          alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + e.message);
        }
      };
      reader.readAsText(file);
    }

    // ===== UI: —Å–æ–±—ã—Ç–∏—è =====
    searchInput.addEventListener('input', () => { searchQuery = searchInput.value.trim(); renderList(); });
    clearSearchBtn.addEventListener('click', () => { searchQuery = ''; searchInput.value=''; renderList(); });

    newBtn.addEventListener('click', createNewTemplate);
    dupBtn.addEventListener('click', duplicateTemplate);
    moveBtn.addEventListener('click', moveTemplateToSection);
    delBtn.addEventListener('click', deleteTemplate);

    saveBtn.addEventListener('click', saveTemplate);
    copyBtn.addEventListener('click', copyCompiled);
    resetVarsBtn.addEventListener('click', resetVariablesValues);
    clearTemplateBtn.addEventListener('click', clearTemplateForm);
    wrapSelectionBtn.addEventListener('click', wrapSelectionWithVar);
    manageSectionsBtn.addEventListener('click', openSectionsModal);
    sectionsClose.addEventListener('click', closeSectionsModal);
    sectionsModal.addEventListener('click', (e) => { if (e.target === sectionsModal) closeSectionsModal(); });
    addRootSectionBtn.addEventListener('click', addSectionRoot);
    addChildSectionBtn.addEventListener('click', addSectionChild);
    renameSectionBtn.addEventListener('click', renameSection);
    deleteSectionBtn.addEventListener('click', deleteSection);

    contentEl.addEventListener('input', renderVarsAndPreview);
    titleEl.addEventListener('input', () => savedAtEl.textContent = '‚Äî');
    descEl.addEventListener('input', () => savedAtEl.textContent = '‚Äî');
    tagsEl.addEventListener('input', () => savedAtEl.textContent = '‚Äî');

    exportBtn.addEventListener('click', exportData);
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', (e) => { const f = e.target.files?.[0]; if (f) importData(f); importFile.value=''; });

    // ===== –¢–µ–º–∞ (—Å–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è) =====
    function applyTheme(theme) {
      if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeBtn.textContent = '–¢–µ–º–∞: –¢—ë–º–Ω–∞—è';
      } else {
        document.documentElement.removeAttribute('data-theme');
        themeBtn.textContent = '–¢–µ–º–∞: –°–≤–µ—Ç–ª–∞—è';
      }
    }
    function loadTheme() {
      try { return localStorage.getItem(THEME_KEY) || 'light'; } catch { return 'light'; }
    }
    function saveTheme(t) { try { localStorage.setItem(THEME_KEY, t); } catch {} }
    themeBtn.addEventListener('click', () => {
      const current = loadTheme();
      const next = current === 'dark' ? 'light' : 'dark';
      saveTheme(next); applyTheme(next);
    });

    document.addEventListener('keydown', (e) => {
      if (!e.ctrlKey) return;
      if (e.key.toLowerCase() === 's') { e.preventDefault(); saveTemplate(); }
      if (e.key.toLowerCase() === 'n') { e.preventDefault(); createNewTemplate(); }
      if (e.key.toLowerCase() === 'b') { e.preventDefault(); copyCompiled(); }
      if (e.key.toLowerCase() === 'e') { e.preventDefault(); exportData(); }
    });

    // ====== –û–±–ª–∞–∫–æ (Supabase REST) ======
    const CLOUD_CFG_KEY = 'prompt_studio.cloud.supabase.v1';
    function loadCloudCfg() {
      try { return JSON.parse(localStorage.getItem(CLOUD_CFG_KEY) || '{}'); } catch { return {}; }
    }
    function saveCloudCfg(cfg) {
      localStorage.setItem(CLOUD_CFG_KEY, JSON.stringify(cfg));
    }

    function openSettings() {
      const cfg = loadCloudCfg();
      supabaseUrlEl.value = cfg.url || '';
      supabaseKeyEl.value = cfg.key || '';
      supabaseTableEl.value = cfg.table || 'templates';
      cloudScopeEl.value = cfg.scope || 'templates';
      settingsModal.style.display = 'flex';
    }
    function closeSettings() { settingsModal.style.display = 'none'; }

    async function cloudPush() {
      const cfg = loadCloudCfg();
      if (!cfg.url || !cfg.key) { toast('–£–∫–∞–∂–∏—Ç–µ Supabase –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö'); return; }
      const table = cfg.table || 'templates';
      try {
        const resp = await fetch(`${cfg.url.replace(/\/$/,'')}/rest/v1/${table}?on_conflict=id`, {
          method: 'POST',
          headers: {
            'apikey': cfg.key,
            'Authorization': `Bearer ${cfg.key}`,
            'Content-Type': 'application/json',
            'Prefer': 'resolution=merge-duplicates,return=minimal'
          },
          body: JSON.stringify(templates)
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        if ((cfg.scope || 'templates') === 'all') {
          // push sections
          await fetch(`${cfg.url.replace(/\/$/,'')}/rest/v1/sections?on_conflict=id`, {
            method: 'POST',
            headers: { 'apikey': cfg.key, 'Authorization': `Bearer ${cfg.key}`, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates,return=minimal' },
            body: JSON.stringify(sections)
          });
          // push variables as rows {templateId, values}
          const varsRows = Object.entries(allVars).map(([templateId, values]) => ({ templateId, values }));
          await fetch(`${cfg.url.replace(/\/$/,'')}/rest/v1/variables?on_conflict=templateId`, {
            method: 'POST',
            headers: { 'apikey': cfg.key, 'Authorization': `Bearer ${cfg.key}`, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates,return=minimal' },
            body: JSON.stringify(varsRows)
          });
        }
        toast('–í—ã–≥—Ä—É–∂–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ');
      } catch (e) {
        toast('–û—à–∏–±–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏: ' + e.message);
      }
    }

    async function cloudPull() {
      const cfg = loadCloudCfg();
      if (!cfg.url || !cfg.key) { toast('–£–∫–∞–∂–∏—Ç–µ Supabase –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö'); return; }
      const table = cfg.table || 'templates';
      try {
        const resp = await fetch(`${cfg.url.replace(/\/$/,'')}/rest/v1/${table}?select=*`, {
          headers: {
            'apikey': cfg.key,
            'Authorization': `Bearer ${cfg.key}`
          }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const rows = await resp.json();
        if (!Array.isArray(rows)) throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç');
        templates = rows.map(r => ({
          id: r.id,
          title: r.title,
          description: r.description,
          author: r.author || '',
          tags: Array.isArray(r.tags) ? r.tags : (typeof r.tags === 'string' ? r.tags.split(',').map(s=>s.trim()).filter(Boolean) : []),
          content: r.content,
          sectionId: r.sectionId || sections[0]?.id || null,
          updatedAt: r.updatedAt || nowIso()
        }));
        saveTemplates(templates);
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø—Ä–∏ scope=all –ø–æ–¥—Ç—è–Ω—É—Ç—å sections –∏ variables
        if ((cfg.scope || 'templates') === 'all') {
          // sections
          const secResp = await fetch(`${cfg.url.replace(/\/$/,'')}/rest/v1/sections?select=*`, {
            headers: { 'apikey': cfg.key, 'Authorization': `Bearer ${cfg.key}` }
          });
          if (secResp.ok) {
            const secs = await secResp.json();
            if (Array.isArray(secs)) {
              sections = secs.map(s => ({ id: s.id, name: s.name, parentId: s.parentId || null }));
              saveSections(sections);
            }
          }
          // variables
          const varsResp = await fetch(`${cfg.url.replace(/\/$/,'')}/rest/v1/variables?select=*`, {
            headers: { 'apikey': cfg.key, 'Authorization': `Bearer ${cfg.key}` }
          });
          if (varsResp.ok) {
            const varsRows = await varsResp.json();
            if (Array.isArray(varsRows)) {
              const merged = {};
              for (const row of varsRows) {
                const tid = row.templateId;
                merged[tid] = row.values || {};
              }
              allVars = merged; saveVars(allVars);
            }
          }
        }
        renderAll();
        toast(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞: ${templates.length}`);
      } catch (e) {
        toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
      }
    }

    settingsBtn.addEventListener('click', openSettings);
    settingsClose.addEventListener('click', closeSettings);
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettings(); });
    settingsSave.addEventListener('click', () => {
      const cfg = {
        url: supabaseUrlEl.value.trim(),
        key: supabaseKeyEl.value.trim(),
        table: supabaseTableEl.value.trim() || 'templates',
        scope: cloudScopeEl.value
      };
      saveCloudCfg(cfg);
      toast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      closeSettings();
    });
    cloudPushBtn.addEventListener('click', cloudPush);
    cloudPullBtn.addEventListener('click', cloudPull);

    // ===== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è =====
    let toastTimer = null;
    function toast(msg) {
      let el = document.getElementById('toast');
      if (!el) {
        el = document.createElement('div');
        el.id = 'toast';
        el.style.position = 'fixed';
        el.style.bottom = '16px';
        el.style.right = '16px';
        el.style.padding = '10px 12px';
        el.style.border = '1px solid var(--border)';
        el.style.background = 'linear-gradient(180deg,#12243a,#0c1a2d)';
        el.style.color = 'var(--text)';
        el.style.borderRadius = '10px';
        el.style.boxShadow = '0 8px 40px rgba(0,0,0,.45)';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = '1';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { el.style.opacity = '0'; }, 1600);
    }

    // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
    function renderAll() {
      ensureTemplateSections();
      renderSectionsBar();
      renderList();
      loadEditor(getCurrent());
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    applyTheme(loadTheme());
    renderAll();
  </script>
</body>
</html>